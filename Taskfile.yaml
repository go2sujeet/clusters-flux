version: '3'

env:
  GITHUB_USER: merusso

dotenv:
  - .env
  - .ignore/.env

tasks:
  bootstrap: 
    desc: Bootstrap Flux on a new cluster
    # cmd: flux bootstrap github
    #   --owner={{.GITHUB_USER}}
    #   --repository=clusters-flux
    #   --branch=main
    #   --path=./alpaca
    #   --personal
    cmds:
      - task: install
      - task: bootstrap-git-secret
      - kubectl apply -f alpaca/flux-system
  
  bootstrap-git-secret:
    cmd: >
      flux create secret git flux-system --username $GITHUB_USER --password $GITHUB_TOKEN
      --url=https://github.com/merusso/clusters-flux.git

  install: flux install
  
  reconcile:
    desc: Manually trigger Flux reconciliation
    cmds:
      - flux reconcile kustomization flux-system --with-source
      - flux reconcile source git cluster-components-flux
      - flux reconcile kustomization components --with-source

  suspend: flux suspend kustomization flux-system
  resume: flux resume kustomization flux-system
  
  uninstall:
    desc: Uninstall Flux on a cluster
    summary: |
      Uninstall Flux on a cluster.
      Note: Does not remove components installed via Flux
    cmd: flux uninstall
